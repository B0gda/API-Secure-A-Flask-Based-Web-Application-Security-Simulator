name: ZAP DAST (Baseline)

on:
  workflow_dispatch:
  push:
  pull_request:

permissions:
  contents: read
  actions: read
  issues: write

jobs:
  dast:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install app deps
        run: |
          python -m pip install --upgrade pip

          # Сначала ставим requirements если он есть
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          elif [ -f "Requirements.txt" ]; then
            pip install -r Requirements.txt
          elif [ -f "secure_API/requirements.txt" ]; then
            pip install -r secure_API/requirements.txt
          elif [ -f "secure_API/Requirements.txt" ]; then
            pip install -r secure_API/Requirements.txt
          else
            echo "requirements file not found, continue with minimal deps"
          fi

          # Критичные зависимости для запуска secure_API/file1.py ставим ВСЕГДА
          pip install flask flask-sqlalchemy sqlalchemy bleach flask-limiter requests

      - name: Run Flask app (background) and wait
        run: |
          # Запускаем сервер и сохраняем PID
          nohup python -u secure_API/file1.py > flask.log 2>&1 & echo $! > flask.pid
          echo "Started Flask PID=$(cat flask.pid), waiting for http://127.0.0.1:5000/"

          # Ждем, пока поднимется
          for i in {1..40}; do
            if curl -sSf http://127.0.0.1:5000/ > /dev/null; then
              echo "Flask is up"
              exit 0
            fi

            # Если процесс уже умер, печатаем лог и падаем
            if ! ps -p "$(cat flask.pid)" > /dev/null; then
              echo "Flask process exited early. Printing flask.log:"
              echo "--------------------------------------------"
              cat flask.log || true
              echo "--------------------------------------------"
              exit 1
            fi

            sleep 2
          done

          echo "Timeout waiting for Flask. Printing flask.log:"
          echo "--------------------------------------------"
          cat flask.log || true
          echo "--------------------------------------------"
          exit 1

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: "http://127.0.0.1:5000/"
          cmd_options: "-a -m 2"

      - name: Upload ZAP reports + server log
        uses: actions/upload-artifact@v4
        with:
          name: dast-zap-report
          path: |
            report_html.html
            report_json.json
            report_md.md
            flask.log
